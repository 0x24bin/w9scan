#!/usr/bin/env python
# -*- coding: utf-8 -*-
# @Author: w8ay
# @Date:   2017年12月19日 12:04:55
import os
from lib.core.data import paths
import imp
from lib.core.log import *
from thirdparty import miniCurl
from lib.utils import until
from lib.core.data import urlconfig
from thirdparty import hackhttp
from thirdparty.ThreadPool import ThreadPool
import threading,Queue
import traceback,time

class Exploit_run(object):

    def __init__(self,threadNum = 10):
        self.hash_pycode_Lists = {}
        self.outputLock = threading.Lock()

        filter_func = lambda file: (True, False)['__init__' in file or 'pyc' in file]
        dir_exploit = filter(filter_func, os.listdir(paths.w9scan_Plugin_Path))

        self._TargetScanAnge = {'target': urlconfig.url,
                                'scanport': urlconfig.scanport}

        try:
            for exp in dir_exploit:
                with open(os.path.join(paths.w9scan_Plugin_Path,exp), 'rb') as f:
                    reads = str(f.read())
                    f.close()
                    self.hash_pycode_Lists.setdefault(exp, reads)
        except Exception as error_info:
            self._print(error_info)


        self._print('[***] Fetch %d new plugins' % len(self.hash_pycode_Lists))
        self.threadNum = threadNum

        self._dbLock = threading.Lock()

        self._print('[***] Set the number of concurrent: %d'%(threadNum))
        self.task_queue = Queue.Queue()


    def _load_module(self,chunk,name='<w9scan>'):
        pluginObj = imp.new_module(str(name))
        exec chunk in pluginObj.__dict__
        return pluginObj
    
    def load_modules(self,service,url):
        # 内部载入所有模块，并且判断服务名是否正确
        
        for k, v in self.hash_pycode_Lists.iteritems():
            pluginObj = self._load_module(v)
            pluginObj.task_push = self.task_push
            pluginObj.curl = miniCurl.Curl()
            pluginObj.security_note = self._security_note
            pluginObj.security_info = self._security_info
            pluginObj.security_warning = self._security_warning
            pluginObj.security_hole = self._security_hole
            pluginObj.debug = self._debug
            pluginObj.util = until
            pluginObj._G = self._TargetScanAnge
            pluginObj.hackhttp = hackhttp.hackhttp()

            try:
                pluginObj_tuple = pluginObj.assign(service, url)
                if not isinstance(pluginObj_tuple, tuple):  # 判断是否是元组
                    continue
                bool_value, agrs = pluginObj_tuple[0], pluginObj_tuple[1]
                if bool_value:
                    threadConf = dict()
                    threadConf["filename"] = k
                    threadConf["service"] = service
                    threadConf["agrs"] = agrs
                    threadConf["pluginObj"] = pluginObj
                    self.task_queue.put(threadConf)
                    self._print(
                        "[***] load plugin %s for service '%s'" % (threadConf["filename"], threadConf["service"]))
            except Exception as err_info:
                self._print("[!!!] load error:", service, k, err_info)

    def run(self):
        Thread_Pool_Obj = ThreadPool(self.threadNum)
        while True:
            Busy = Thread_Pool_Obj.busy()  # 繁忙

            if self.task_queue.qsize():
                for x in range(min(Thread_Pool_Obj.idel(), self.task_queue.qsize())):

                    try:
                        threadConf = self.task_queue.get()
                        Thread_Pool_Obj.push(self._work, threadConf)
                    except Exception as error_info:
                        print "[!!!] queue error:>>> ", error_info

            elif Busy == 0:
                break
            Thread_Pool_Obj.wait_for_idel(5)

        Thread_Pool_Obj.wait()

    def _work(self,threadConf):
        # 程序内部工作线程
        self._print("[***] running plugin %s for service '%s'" % (threadConf["filename"], threadConf["service"]))
        try:
            pluginObj = threadConf["pluginObj"]
            pluginObj.audit(threadConf["agrs"])

        except Exception as error_info:
            self._print( "[!!!] ",threadConf["service"], threadConf["filename"],error_info)


    def _security_note(self, body, uuid=None):
        self.outputLock.acquire()
        logger.security_note(body)
        self.outputLock.release()

    def _security_info(self, body, uuid=None):
        self.outputLock.acquire()
        logger.security_info(body)
        self.outputLock.release()

    def _security_warning(self, body, uuid=None):
        self.outputLock.acquire()
        logger.security_warning(body)
        self.outputLock.release()

    def _security_hole(self, body, uuid=None):
        self.outputLock.acquire()
        logger.security_hole(body)
        self.outputLock.release()

    def _debug(self, fmt, *args):
        if len(args) >= 3:
            self._print( "[debug] < ", fmt % args, " >")

    def task_push(self, serviceType, target_info, uuid=None, target=None, pr=-1):
        self.load_modules(serviceType,target_info)

    def _print(self,*args):
        # fix Typerror bug
        self.outputLock.acquire()
        print(u''.join([str(i) for i in args]))
        self.outputLock.release()